#{extends themeInfo.get('themeLayout') /}

<script id='delving-wysiyg' src="@{routes.Assets.at('/common/javascripts/tiny_mce/tiny_mce.js')}" type='text/javascript'></script>

#{set title: messages.get('thing.pages') /}

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"site", isOwner: isOwner, isCMSAdmin: isCMSAdmin /}
<div class="row">
    <div class="grid_12 sup-panel">
       #{cmsNavBar active:'page', currentLanguage:currentLanguage, orgId: orgId/}
    </div>
</div>


<div class="row">
    <div class="grid_12">
        <form id="pageForm" method="post" action="">
            <div data-bind="text: errors().global"></div>

            #{textField name:"key", form:pageForm, label:messages.get('org.cms.page.key'), dataBind:"value: key", required: true, enabled: !isNew /}
            #{populatedSelectField options:themes, name:"theme", form: pageForm, label:messages.get('ui.label.theme'), dataBind:"value: theme", required: true /}
            #{populatedSelectField options:languages, name:"lang", form: pageForm, label:messages.get('ui.label.language'), dataBind:"value: lang", required: true /}
            #{textField name:"title", form:pageForm, label:messages.get('thing.title'), dataBind:"value: title", required: true /}
            #{textArea name:"pageContent", form: pageForm, extraClass:"mceEditor", label:messages.get('thing.content'), dataBind:"tinymce: content, tinymceOptions: {orgId: '${orgId}'}", required: true /}

            <div class="field">
                <label class="label">&{'org.cms.page.menu.add'}</label>

                <div class="inputs">
                    <select name="menu" id="menu" data-bind="value: menu">
                        <option value="none">None</option>
                        <option value="mainMenu">Main menu</option>
                    </select>
                </div>
            </div>

            #{textField name:"position", form: pageForm, label:messages.get('org.cms.page.menu.position'), dataBind:"value: position", required: true /}

            <div class="buttons">
                #{btnButton label: messages.get('ui.label.cancel'), extraClass:"cancelButton beware", id:"cancelButton", type:"reset" /}
                #{btnButton label: messages.get('ui.label.reset'), extraClass:"submit", type:"reset" /}
                #{btnButton label: messages.get('org.cms.page.save'), extraClass:"action complete", id:"saveButton", type:"submit" /}
                <div class="wait"></div>
            </div>

        </form>
    </div>
</div>
<div class="row">
    <div class="grid_12">
        <div class="data-grid" style="display:block">
            <table class="list" id="versions">
                <caption>Previous versions</caption>
                <thead>
                <tr>
                    <th>&{'thing.title'}</th>
                    <th>&{'thing.datecreated'}</th>
                    <th>&{'thing.actions'}</th>
                </tr>
                </thead>
                <tbody data-bind="foreach: versions()">
                <tr>
                    <td>
                        <span class="page-title" data-bind="text: title"></span>
                    </td>
                    <td>
                        <span class="page-title" data-bind="text: $.format.date(new Date(dateCreated()), 'dd MMM yyyy HH:mm')"></span>
                    </td>
                    <td>
                        <a class="" href="#" data-bind="click: function() { $parent.loadVersion($data) }">
                            <span class="label">&{'ui.label.load'}</span>
                        </a>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
    $(document).ready(function() {
        var pageModel = {};
        var versionsModel = {
            loadVersion: function(version) {
                pageModel.key(version.key());
                pageModel.lang(version.lang());
                pageModel.title(version.title());
                pageModel.content(version.content());
            }
        };
        load(${page.raw()}, pageModel, document.getElementById('pageForm'), function() {
            load(${versions.raw()}, versionsModel, document.getElementById('versions'), function() {
                $("body").css('visibility', 'visible');
            });
        });

        $('#saveButton').click(function(event) {
            event.preventDefault();
            handleSubmit('/organizations/${orgId}/site/page', pageModel, '#pageForm', null, function() {
                document.location = '/organizations/${orgId}/site/' + pageModel.lang();
            });
        });
    });
</script>