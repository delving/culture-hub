#{set 'visibility'}hidden#{/}
#{extends viewUtils.themeProperty('themeLayout') /}
#{set title: id.isEmpty() ? viewUtils.getKey('user.object.title.create', fullName) : viewUtils.getKey('user.object.title.update', fullName) /}

#{set 'moreCss'}
<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/common/stylesheets/plugins/jquery.multiselect.css'}"/>
<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/common/stylesheets/plugins/jquery.multiselect.filter.css'}"/>
#{/set}

#{breadcrumbs /}
<h1 class="sep">${id.isEmpty() ? viewUtils.getKey('user.object.create') : viewUtils.getKey('user.object.update') }</h1>

<div class="row">

<form id="objectForm" method="post" action="" class="grid_10">
    <div data-bind="text: errors().global"></div>

    #{textField name:"name", label:viewUtils.getKey('thing.name'), dataBind:"value: name", required: true /}
    #{textArea name:"description", label:viewUtils.getKey('thing.description'), dataBind:"value: description", required: true /}

    *{<div data-bind="template: {name: 'addLabelTemplate', templateOptions: {name: 'label', labels: labels, labelType: labelType, labelValue: labelValue, addLabel: addLabel}}"></div>}*

    <div class="field">
        <label class="label" for="collection">&{'user.object.label.addToCollection'}</label>
        <select id="collection" name="repositories" multiple="multiple" data-bind="jqMultiSelect: { filter: false }, selectedOptions: collections, options: availableCollections, optionsText: 'name', optionsValue: 'id'"></select>
    </div>

    <div class="field" for="objectVisibility">
        <label class="label">&{'ui.label.visibility'}</label>

        <div class="inputs">
            <input type="radio" name="public" value="${models.Visibility.PRIVATE().value}" data-bind="checked: visibility"/>&{'ui.label.visibility.notpublic'} <br/>
            <input type="radio" name="public" value="${models.Visibility.PUBLIC().value}" data-bind="checked: visibility"/>&{'ui.label.visibility.public'}
        </div>
    </div>

    <fieldset>
    <div class="field">
        <label class="label">&{'user.object.label.file'}</label>

        <div class="inputs">
            <div id="fileupload"></div>
        </div>
    </div>
    </fieldset>


    <div class="buttons">
        #{btnButton label: viewUtils.getKey('ui.label.cancel'), extraClass:"cancelButton beware", id:"cancelButton", type:"reset" /}
        #{btnButton label: viewUtils.getKey('ui.label.reset'), extraClass:"submit", type:"reset" /}
        #{btnButton label: viewUtils.getKey('user.object.save'), extraClass:"action complete", id:"saveButton", type:"submit" /}
        <div class="wait"></div>

    </div>

</form>

</div>

<script type="text/html" id="simpleUploadFileTemplate">
    <form action="#" method="post" enctype="multipart/form-data">
        <div class="fileupload-buttonbar">
            <label class="fileinput-button">
                <span>&{'ui.label.filesadd'}</span>
                <input type="file" name="files[]" multiple="true"/>
            </label>
        </div>
    </form>
    <div class="fileupload-content">
        <table class="files"></table>
    </div>
</script>
<script type="text/javascript">
    $(document).ready(function() {

      var objectModel = {
          labelType: ko.observable(""),
          labelValue: ko.observable(""),
          addLabel: function() {
              objectModel.labels.push({labelType: objectModel.labelType(), value: objectModel.labelValue()});
              objectModel.labelType("");
              objectModel.labelValue("");
          },
          removeLabel: function(label) {
              objectModel.labels.remove(function(it) {
                  return it.labelType === label.labelType && it.value === label.value
              });
          }
      };

      // load templates and data
      $.get("/asset?path=/public/common/templates/_addLabel.tmpl.html", null, function(template) {
        addTemplate('addLabelTemplate', template);
        load(${data.raw()}, objectModel, null, function() {
            var files = ko.toJS(objectModel.files);
            var fu = $('#fileupload').data('fileupload');
            fu._adjustMaxNumberOfFiles(-files.length);
            fu._renderDownload(files)
                    .appendTo($('#fileupload .files'))
                    .fadeIn(function () {
                        // Fix for IE7 and lower:
                        $(this).show();
                    });
            $("body").css('visibility', 'visible');
        });
      });

      $.tmpl($('#simpleUploadFileTemplate')).appendTo('#fileupload');
      initUploadWidget(true);
      $('#fileupload').fileupload({
          url: '@{user.FileUpload.uploadFile(uid)}',
          autoUpload: true
      }).bind('fileuploadsend', function (e, data) {
          $('.buttons').find('button').prop('disabled', true);
      }).bind('fileuploaddone', function (e, data) {
          $('.buttons').find('button').prop('disabled', false);
      });

      $('#saveButton').click(function(event) {
        event.preventDefault();
        var files = $('#fileupload .files tr');
        var selected = $($.grep(files, function(el, idx) { return $(el).find('td.selected input').is(':checked')})[0]);
        var selectedId = selected.find('td.id').text();
        var selectedName = selected.find('td.name').text();
        if(selectedId == "" && files.length > 0) {
          objectModel.selectedFile(selectedName);
        } else {
          objectModel.selectedFile(selectedId);
        }
        handleSubmit('/${userName}/object/submit', objectModel, '#objectForm', '/${userName}/object/', null, null, {uid: '${uid}'});
      });

    });
</script>