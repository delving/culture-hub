#{extends viewUtils.themeProperty('themeLayout') /}
#{set title: id.isEmpty() ? viewUtils.getKey('user.object.title.create', fullName) : viewUtils.getKey('user.object.title.update', fullName) /}

#{set 'moreCss'}
<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/themes/common/stylesheets/plugins/jquery.multiselect.css'}"/>
<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/themes/common/stylesheets/plugins/jquery.multiselect.filter.css'}"/>
#{/set}

#{breadcrumbs /}
<h1 class="sep">${id.isEmpty() ? viewUtils.getKey('user.object.create') : viewUtils.getKey('user.object.update') }</h1>
<form id="objectForm" method="post" action="">
    <div data-bind="text: errors().global"></div>

    #{textField name:"name", label:viewUtils.getKey('thing.name'), dataBind:"value: name", required: true /}
    #{textArea name:"description", label:viewUtils.getKey('thing.description'), dataBind:"value: description", required: true /}

    <div data-bind="template: {name: 'addLabelTemplate', templateOptions: {name: 'label', labels: labels, labelType: labelType, labelValue: labelValue, addLabel: addLabel}}"></div>

    <div class="field">
        <label class="label" for="collection">&{'user.object.label.addToCollection'}</label>
        <select id="collection" name="repositories" multiple="multiple" data-bind="jqMultiSelect: { filter: false }, selectedOptions: collections, options: availableCollections, optionsText: 'name', optionsValue: 'id'"></select>
    </div>

    <div class="field" for="objectVisibility">
        <label for="public-0" class="label">&{'ui.label.visibility'}</label>

        <div class="inputs">
            <input type="radio" checked="checked" value="0" id="public-0" name="public">&{'ui.label.visibility.notpublic'}
            <input type="radio" value="1" id="public-1" name="public">&{'ui.label.visibility.public'}
        </div>
    </div>
    <fieldset>
    <div class="field">
        <label class="label">&{'user.object.label.file'}</label>

        <div class="inputs">
            <div id="fileupload"></div>
        </div>
    </div>
    </fieldset>


    <div class="buttons">
        #{btnButton label: viewUtils.getKey('user.object.save'), extraClass:"blue", id:"saveButton", type:"submit" /}
        <div class="wait"></div>
    </div>

</form>

<script type="text/javascript">
    $(document).ready(function() {

        // load templates
        $.get("/asset?path=/public/themes/common/templates/_addLabel.tmpl.html", null, function(template) {
            addTemplate('addLabelTemplate', template);
        });

        $.tmpl($('#simpleUploadFileTemplate')).appendTo('#fileupload');
        initUploadWidget();
        $('#fileupload').fileupload({
            url: '@{user.FileUpload.uploadFile(uid)}',
            autoUpload: true
        });

        var objectModel = {
            labelType: ko.observable(""),
            labelValue: ko.observable(""),
            addLabel: function() {
                objectModel.labels.push({labelType: objectModel.labelType(), value: objectModel.labelValue()});
                objectModel.labelType("");
                objectModel.labelValue("");
            },
            removeLabel: function(label) {
                objectModel.labels.remove(function(it) {
                    return it.labelType === label.labelType && it.value === label.value
                });
            }
        };

        $('#saveButton').click(function(event) {
            event.preventDefault();
            handleSubmit('/${userName}/object/submit', objectModel, '#objectForm', '/${userName}/object/', null, null, {uid: '${uid}'});
        });

        load('/${userName}/object/load/${id.isEmpty() ? "" : id.get()}', objectModel, null, function() {
            var files = ko.toJS(objectModel.files);
            var fu = $('#fileupload').data('fileupload');
            fu._adjustMaxNumberOfFiles(-files.length);
            fu._renderDownload(files)
                    .appendTo($('#fileupload .files'))
                    .fadeIn(function () {
                        // Fix for IE7 and lower:
                        $(this).show();
                    });
        });
    });
</script>