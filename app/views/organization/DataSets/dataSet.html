#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.dataset') + ' ' + spec + ' - ' + messages.get('thing.organization') + ': ' + orgId /}
#{set bodyId: 'organization' /}
#{breadcrumbs /}

<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/organizations/datasets.js")}"></script>

#{organizationNavBar orgId: orgId, active: "datasets", navigation: navigation /}

<div class="row">
    <div class="span4">

        <table class="table table-condensed table-wrap">
            <caption>Basic information</caption>
            <tbody>
                <tr>
                    <th width="100">&{'thing.creator'}</th>
                    <td><span data-bind="text: creator"></span></td>
                </tr>
                <tr>
                    <th>Spec (Identifier)</th>
                    <td><span data-bind="text: spec"></span></td>
                </tr>
                <tr>
                    <th>Name</th>
                    <td data-bind="text: name"></td>
                </tr>
                <tr>
                    <th>Language</th>
                    <td data-bind="text: information.language"></td>
                </tr>
                <tr>
                    <th>Country</th>
                    <td data-bind="text: information.country"></td>
                </tr>
                <tr>
                    <th>Provider</th>
                    <td data-bind="text: nodeName"></td>
                </tr>
                <tr>
                    <th>Data Provider</th>
                    <td data-bind="text: information.dataProvider"></td>
                </tr>
                <tr>
                    <th>Rights</th>
                    <td><span data-bind="text: information.rights, attr: {title: information.rights}"></span></td>
                </tr>
                <tr>
                    <th>Type</th>
                    <td data-bind="text: information.type"></td>
                </tr>
            </tbody>
        </table>

        <table class="table table-condensed table-stacked">
            <caption>Processing configuration</caption>
            <thead>
            <tr>
                <th>Output schema</th>
                <th>OAI-PMH Access rights</th>
            </tr>
            </thead>
            <tbody data-bind="foreach: harvestingConfiguration">
            <tr>
                <td><span class="label" data-bind="text: schema"></span></td>
                <td><span data-bind="text: accessType"></span></td>
            </tr>
            </tbody>
        </table>

        <table class="table table-condensed">
            <thead>
            <tr>
                <th>Indexing and rendering schema</th>
            </tr>
            </thead>
            <tbody>
            <tr>
                <td>
                    <!-- ko if: indexingSchema().length > 0 -->
                    <span class="label" data-bind="text: indexingSchema"></span>
                    <!-- /ko -->
                    <!-- ko ifnot: indexingSchema().length > 0 -->
                    <span>No schema selected</span>
                    <!-- /ko -->
                </td>
            </tr>
            </tbody>
            <tfoot>
            <tr>
                <td>
                    <a class="btn pull-right" href="/organizations/${orgId}/dataset/${spec}/update"><i class="icon icon-edit"></i> ${messages.get('ui.label.edit')}</a>
                </td>
            </tr>
            </tfoot>
        </table>
    </div>


    <div class="span8">

        <div data-bind="template: { name: 'statusInformation' }"></div>

        <h4>Dataset actions</h4>
        <div class="">

            <div class="btn-toolbar">
                <div class="btn-group">
                    <button class="btn" data-loading-text="..." data-bind="css: { disabled: dataSetState() != 'disabled' }, click: function() { enable(spec); }">Enable</button>
                    <button class="btn" data-bind="css: { disabled: dataSetState() != 'enabled' }, click: function() { disable(spec); }">Disable</button>
                    <button class="btn" data-bind="css: { disabled: dataSetState() != 'uploaded' && dataSetState() != 'enabled' && dataSetState() != 'disabled' && dataSetState() != 'error' }, click: function() { process(spec); }">Process</button>
                </div>
                <div class="btn-group">
                    <a class="btn dropdown-toggle" data-toggle="dropdown" href="#">
                        Expert actions
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li><a data-bind="click: function() { unlock(spec); } "><i class="icon icon-lock"></i> Unlock</a></li>
                        <li><a data-bind="click: function() { resetHashes(spec); }"><i class="icon icon-warning-sign"></i> Reset Hashes</a></li>
                        <li><a data-bind="click: function() { deleteSet(spec); }"><i class="icon icon-remove"></i> Delete</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!-- 2nd alert class (alert-...) determined by state of dataset -->
        <div id="state-alert" data-bind="attr: { class: 'alert alert-' + stateToClass(dataSetState())}">

            Dataset state: <strong data-bind="text: dataSetState"></strong>

            <!-- ko if: errorMessage().length > 0 -->
            <p data-bind="text: errorMessage"></p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'incomplete' -->
            <p>The DataSet has been created but not yet uploaded by the Sip-Creator. It requires source data and a mapping.</p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'parsing' -->
            <p>The source data sent via the SIP-Creator is currently being parsed and stored into BaseX.</p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'uploaded' -->
            <p>The DataSet is uploaded and ready to be processed.</p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'queued' -->
            <p>The DataSet is queued and waiting to be processed.</p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'processing' -->
            <p>The DataSet is being processed. The source records are transformed into the selected output schemas, and if an indexing schema is selected, the set is also being indexed in SOLR.</p>
            <div>
                <div class="progress progress-striped active" data-bind="css: { active: progressPercentage != '0%' }">
                    <div class="bar" data-bind="style: { width: progressPercentage() }"></div>
                </div>
                <button class="btn" data-bind="css: { disabled: dataSetState() != 'processing' }, click: function() { cancel(spec); }">Cancel</button>
            </div>

            <!-- /ko -->

            <!-- ko if: dataSetState() == 'cancelled' -->
            <p>The processing of this set was cancelled by the user.</p>
            <!-- /ko -->

            <!-- ko if: dataSetState() == 'enabled' -->
            <p>The DataSet is enabled and data can be harvested. If an indexing schema is selected, it can also be searched and displayed</p>
            <!-- /ko -->

        </div>




    </div>
</div>

<script type="text/javascript" language="javascript">
    $(document).ready(function () {

        var clientId = Math.floor(1 + 10001 * Math.random());
        var ws = new WebSocket("ws://" + location.host + "/organizations/${orgId}/dataset/feed?clientId=" + clientId + '&spec=${spec}');

        var viewModel = {

            progressPercentage: ko.observable('0%'),

            stateToClass: function(state) {
                return stateToClass(state);
            },
            enable: function(spec) {
                ws.send(JSON.stringify({
                    eventType: 'enableSet',
                    clientId: clientId,
                    payload: '${spec}'
                }));
            },
            disable: function(spec) {
                ws.send(JSON.stringify({
                    eventType: 'disableSet',
                    clientId: clientId,
                    payload: '${spec}'
                }));
            },
            process: function(spec) {
                ws.send(JSON.stringify({
                    eventType: 'processSet',
                    clientId: clientId,
                    payload: '${spec}'
                }));
            },
            cancel: function(spec) {
                ws.send(JSON.stringify({
                    eventType: 'cancelProcessSet',
                    clientId: clientId,
                    payload: '${spec}'
                }));
            },
            unlock: function(spec) {
                ws.send(JSON.stringify({
                    eventType: 'unlockSet',
                    clientId: clientId,
                    payload: '${spec}'
                }));
            },
            resetHashes: function(spec) {
                bootbox.confirm("<h4>Reset hashes</h4><p>Are you sure?</p>", function(result) {
                     if (result) {
                        ws.send(JSON.stringify({
                            eventType: 'resetHashesForSet',
                            clientId: clientId,
                            payload: '${spec}'
                        }));
                     }
                });
            },
            deleteSet: function(spec) {
                bootbox.confirm("<h4>Delete</h4><p>Are you sure?</p><p>This will remove the dataset definition and all data. This action cannot be undone.</p>", function(result) {
                    if (result) {
                        bootbox.confirm("<h4>Delete</h4><p>Are you absolutely sure?</p>", function(result){
                            if (result) {
                                ws.send(JSON.stringify({
                                eventType: 'deleteSet',
                                clientId: clientId,
                                payload: '${spec}'
                                }));
                            }
                        });
                    }
                });
            }
        };

        ws.onopen = function() {
            ws.send(JSON.stringify({
                eventType: "sendSet",
                clientId: clientId,
                payload: '${spec}'
            }));
        };

        ws.onmessage = function(evt) {
            var data = $.parseJSON(evt.data);
            switch(data.eventType) {
                case "loadSet":
                    $.extend(viewModel, ko.mapping.fromJS(data.payload));
                    ko.applyBindings(viewModel);
                    break;
                case "updated":
                    break;
                case "removed":
                    break;
                case "sourceRecordCountChanged":
                    viewModel.totalRecords(data.payload);
                    break;
                case "stateChanged":
                    viewModel.dataSetState(data.payload);
                    viewModel.progressPercentage('0%');
                    viewModel.errorMessage('');
                    break;
                case "locked":
                    viewModel.lockState("locked");
                    viewModel.lockedBy(data.payload);
                    break;
                case "unlocked":
                    viewModel.lockState("unlocked");
                    viewModel.lockedBy("");
                    break;
                case "error":
                    viewModel.errorMessage(data.payload);
                    break;
                case "processedRecordCountChanged":
                    var percentage = 100 * parseInt(data.payload) / viewModel.totalRecords();
                    viewModel.progressPercentage(percentage + '%');
                    break;
            }
        };

    });

</script>
<script type="text/html" id="statusInformation">
    <table class="table table-condensed">
        <caption>Status information</caption>
        <thead>
        <tr>
            <th>State</th>
            <th>Total records</th>
            {{each validRecords}}
            <th>Valid <span class="label" data-bind="text: schema"></span></th>
            {{/each}}
        </tr>
        </thead>
        <tbody>
        <tr>
            <td><span class="badge" data-bind="text: dataSetState, attr: { class: 'badge badge-' + stateToClass(dataSetState()) } "></span></td>
            <td><span data-bind="text: totalRecords"></span></td>
            {{each validRecords}}
            <td><span data-bind="text: valid"></span></td>
            {{/each}}
        </tr>
        </tbody>
    </table>
</script>

