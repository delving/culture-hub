#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.browse.of', messages.get('thing.datasets')) + ': ' + orgId /}

#{set 'moreScripts'}
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.tablesorter.min.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.uitablefilter.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/smartupdater.4.0.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("common/javascripts/bootstrap/bootstrap-popover.js")}"></script>

#{/set}

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", isOwner: isOwner, isCMSAdmin: isCMSAdmin, currentLanguage: currentLanguage /}

<div class="row">
    <div class="span12">
#{if browsedUserName}
    <div class="row">
    &{'thing.organization'}: <span>${browsedOrgName}</span><br/>
    &{'thing.count'}: ${count}
    </div>
#{/if}
#{if items.length() > 0}

    <form id="filter-form" class="form-inline well">
        <label>&{'dataset.find'}: </label>
        <input type='text' name='filter' id='filter' maxlength="30" size="30" class="textinput" placeholder="&{'dataset.filter.beginTyping'}"/>
        <input onclick="resetFilter()" class="btn" type="reset" value="&{'ui.label.reset'}"/>
    </form>


    <table id="dataset-table" class="table table-striped sortable">
        <caption>${messages.get('thing.datasets')}</caption>
        <thead>
        <tr>
            <th width="150" class="sort">&{'thing.name'}</th>
            <th class="sort" width="70">&{'ui.label.nritems'}</th>
            <th class="sort">&{'ui.label.status'}</th>
            <th>&{'ui.label.options'}</th>
            <th width="70">&#160;</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <td colspan="5">
            #{ifnot items.length() > 0}
                {messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}
            #{/ifnot}
            </td>
        </tr>
        </tfoot>
        <tbody>

        #{list items, as: 'i'}
        <tr>
            <td><a href="/organizations/${orgId}/dataset/${i.spec}">${i.spec}</a></td>
            <td width="100"><a href="/search?query=delving_spec%3A${i.spec}">${i.total_records}</a></td>
            <td id="description${i.spec}" width="120">
            #{if i.state.name() == models.DataSetState.ERROR().name()}
                <span class="badge badge-important badge-error" rel="popover" data-original-title="${i.state.description()}" data-content="${i.error.raw()}">&{'ui.label.error'}</span>
                *{<span class="error">${i.state.description()}:<br/>${i.error.raw()}</span>}*
            #{/if}
            #{else}
                    ${i.state.description()}
            #{/else}
            </td>
            <td>
                #{if isOwner}
                    <div class="btn-toolbar nom">
                        <div class="btn-group">
                            <a class="btn btn-primary btn-mini" href="/organizations/${orgId}/dataset/${i.spec}/update">
                                ${messages.get('ui.label.edit')}
                            </a>
                        </div>

                            #{if i.state.name() == models.DataSetState.UPLOADED().name() || i.state.name() == models.DataSetState.ERROR().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/index" method="POST" class="data-set">
                                    <button class="btn btn-mini">&{'dataset.index'}</button>
                                    #{authenticityToken /}
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    <button class="btn btn-mini">&{'dataset.invalidate'}</button>
                                    #{authenticityToken /}
                                </form>
                            #{/if}

                            #{if i.state.name() == models.DataSetState.ENABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/reindex" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini">&{'dataset.reindex'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/disable" method="POST" class="data-set data-set-disable">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini">&{'dataset.disable'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini">&{'dataset.invalidate'}</button>
                                </form>
                            #{/if}

                            #{if i.state.name() == models.DataSetState.QUEUED().name() || i.state.name() == models.DataSetState.PROCESSING().name()}

                                <form action="/organizations/${orgId}/dataset/${i.spec}/cancel" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini"><span >&{'dataset.cancelindex'}</span>
                                    </button>
                                </form>

                            #{/if}

                            #{if i.state.name() == models.DataSetState.DISABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/enable" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini">&{'dataset.enable'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn btn-mini"><span>&{'dataset.invalidate'}</span></button>
                                </form>
                            #{/if}

                    #{ifnot i.lockedBy.isEmpty()}
                    <div class="btn-group">
                        <a class="btn btn-warning btn-mini" id="unlock${i.spec}">
                        ${messages.get('ui.label.unlock')} (${i.lockedBy.get()})
                        </a>
                    </div>
                    #{/ifnot}

                        <script type="text/javascript">
                            $(document).ready(function () {
                                $('#unlock${i.spec}').click(function () {
                                    $.ajax({
                                        url:'/organizations/${orgId}/dataset/${i.spec}/forceUnlock',
                                        type:'POST',
                                        complete:function () {
                                            document.location = "/organizations/${orgId}/dataset";
                                        }
                                    });
                                });
                            });
                        </script>

                        #{if i.state.name() == models.DataSetState.QUEUED().name()}
                         <script type="text/javascript">
                             $('#description${i.spec}').smartupdater({
                                 url: "/organizations/${orgId}/dataset/${i.spec}/state",
                                 minTimeout: 5000
                             }, function (data) {
                                 var d = $.parseJSON(data);
                                 if (d.state == '${models.DataSetState.PROCESSING().name()}' || d.state == '${models.DataSetState.ERROR().name()}') {
                                     // yadaaa
                                     document.location = "/organizations/${orgId}/dataset";
                                 }
                             });
                         </script>
                         #{/if}

                         #{if i.state.name() == models.DataSetState.PROCESSING().name()}
                         <div class="progress progress-striped active">
                             <div class="bar" id="indexCounter${i.spec}"></div>
                         </div>

                         <script type="text/javascript">
                             $('#indexCounter${i.spec}').smartupdater({
                                 url : "/organizations/${orgId}/dataset/${i.spec}/indexingStatus",
                                 minTimeout: 2000
                             }, function (data) {
                                 var d = $.parseJSON(data);
                                 if (d.status == 'DONE') {
                                     $('#indexCounter${i.spec}').smartupdater('stop');
                                     $('#indexCounter${i.spec}').progressbar("value", 100);
                                     $('#indexCounter${i.spec}').css("width","100%");
                                     document.location = "/organizations/${orgId}/dataset";
                                 }
                                 else {
                                     $('#indexCounter${i.spec}').css("width", d.status+"%");
                                 }
                             });
                         </script>
                         #{/if}
                #{/if}
            </div>
            </td>
            <td>
                <div class="btn-group">
                    <a class="btn btn-danger btn-mini delete #{if i.state.name() != models.DataSetState.DISABLED().name() && i.state.name() != models.DataSetState.INCOMPLETE().name() && i.state.name() != models.DataSetState.UPLOADED().name()} disabled#{/if}" id="remove${i.spec}" data-remove="${i.spec}">
                    ${messages.get('ui.label.delete')}
                    </a>
                </div>
            </td>
        </tr>
        #{/list}
        </tbody>
    </table>
#{/}
#{else}
    <p>${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}</p>
#{/}
</div>
</div>

<script type="text/javascript" language="javascript">
    $(document).ready(function () {
        $("#dataset-table").tablesorter();
        var theTable = $('#dataset-table')
        theTable.find("tbody > tr").find("td:eq(1)").mousedown(function () {
            $(this).prev().find(":checkbox").click();
        });
        $("#filter").keyup(function () {
            $.uiTableFilter(theTable, this.value);
        });
        $('#filter-form').submit(
                function () {
                    theTable.find("tbody > tr:visible > td:eq(1)").mousedown();
                    return false;
                }).focus(); //Give focus to input field

        $('.delete:not(.disabled)').click(function() {
            var ds = $(this).attr('data-remove');
            bootboxConfirm({
                'type': 'DELETE',
                'message' : '<h3 class="shout beware">'+ds+'</h3>&{'dataset.confirmDeletion'}',
                'action_url':'/organizations/${orgId}/dataset/'+ ds + '/remove',
                'success_url':'/organizations/${orgId}/dataset'
            });
        });
        $('.delete.disabled').click(function(){
            var ds = $(this).attr('data-remove');
            bootbox.alert('<h3 class="shout">'+ds+'</h3>&{'dataset.disableDatasetForDeletion'}');
        });
        $('.badge-error').popover();
        $('.popover-inner').addClass('large');
    });
    function resetFilter(){
        $.uiTableFilter($('#dataset-table'), '');
        $('input#filter').val('');
    }
</script>