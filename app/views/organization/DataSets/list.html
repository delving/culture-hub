#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.browse.of', messages.get('thing.datasets')) + ': ' + orgId /}

#{set 'moreScripts'}
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.tablesorter.min.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.uitablefilter.js")}"></script>
#{/set}

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", isOwner: isOwner, isCMSAdmin: isCMSAdmin /}

        <div class="tab-content">

            #{if browsedUserName}
            <div class="g-1of1">
                &{'thing.organization'}: <span>${browsedOrgName}</span><br/>
                &{'thing.count'}: ${count}
            </div>
            #{/if}
            #{if items.length() > 0}

            <form id="filter-form" class="pam">


                <div class="buttons">
                #{btnHref label: messages.get('organization.dataset.list'), href:"/organizations/"+orgId+"/dataset", extraClass:"action on" /}
                #{if isOwner == true }
                    #{btnHref label: messages.get('organization.dataset.create'), href:"/organizations/"+orgId+"/dataset/add", visible: isOwner /}
                #{/if}
                #{btnHref label:messages.get('ui.label.sipcreator'), href:"/organizations/"+orgId+"/sip-creator" /}
                </div>

                <hr/>
                <label>&{'dataset.find'}: </label>
                <input type='text' name='filter' id='filter' maxlength="30" size="30" class="textinput"/>
                <hr/>


            </form>

             <div class="data-grid">
                <table width="100%" id="dataset-table" class="sortable">
                    <caption>${messages.get('thing.datasets')}</caption>
                    <thead>
                    <tr>
                        <th width="200">&{'thing.name'}</th>
                        <th>&{'ui.label.nritems'}</th>
                        <th>&{'ui.label.status'}</th>
                        <th>&{'ui.label.options'}</th>
                    </tr>
                    </thead>
                    <tfoot>
                    <tr>
                        <td colspan="4">
                            #{ifnot items.length() > 0}
                            ${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}
                            #{/}
                        </td>
                    </tr>
                    </tfoot>
                    <tbody>

                    #{list items, as: 'i'}
                    <tr>
                        <td><a href="/organizations/${orgId}/dataset/${i.spec}">${i.spec}</a></td>
                        <td width="100"><a href="/search?query=delving_spec%3A${i.spec}">${i.total_records}</a></td>
                        <td id="description${i.spec}" width="150">
                            *{todo enable this again after classloader fix}*
                            *{#{if i.state.name() == models.DataSetState.ERROR().name()}}*
                                *{<span class="error">${i.state.description()}</span>}*
                            *{#{/if}}*
                            *{#{else}}*
                                ${i.state.description()}
                            *{#{/else}}*
                        </td>
                        <td width="550">
                            #{if isOwner}
                            <div class="buttons">
                                <a class="button blue" href="/organizations/${orgId}/dataset/${i.spec}/update">
                                    <span class="label">${messages.get('ui.label.edit')}</span>
                                </a>
                                <a class="button beware"#{if i.state.name() == models.DataSetState.ENABLED().name()} disabled#{/if} id="remove${i.spec}">
                                    <span class="label beware">${messages.get('ui.label.remove')}</span>
                                </a>
                                <a class="button beware"#{if i.lockedBy.isEmpty()} disabled#{/if} id="unlock${i.spec}">
                                    <span class="label beware">${messages.get('ui.label.unlock')}</span>
                                </a>

                                <div id="removeConfirmation" title="&{'thing.confirmation'}" style="display: none;"><p>
                                    <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>&{'dataset.confirmDeletion'}
                                </p></div>
                                <script type="text/javascript">
                                    $(document).ready(function() {
                                        remove('#remove${i.spec}', '#removeConfirmation', '/organizations/${orgId}/dataset/${i.spec}/remove', '/organizations/${orgId}/dataset');
                                        $('#unlock${i.spec}').click(function() {
                                            $.ajax({
                                                url: '/organizations/${orgId}/dataset/${i.spec}/forceUnlock',
                                                type: 'POST',
                                                complete: function() {
                                                    document.location = "/organizations/${orgId}/dataset";
                                                }
                                            });
                                        });
                                    });
                                </script>
                                #{if i.state.name() == models.DataSetState.UPLOADED().name() || i.state.name() == models.DataSetState.ERROR().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/index" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button action complete index"><span class="label">&{'dataset.index'}</span></button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button action invalidate"><span class="label">&{'dataset.invalidate'}</span></button>
                                </form>
                                #{/if}

                                #{if i.state.name() == models.DataSetState.ENABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/reindex" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button reIndex"><span class="label">&{'dataset.reindex'}</span></button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/disable" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button reIndex"><span class="label">&{'dataset.disable'}</span></button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button action invalidate"><span class="label">&{'dataset.invalidate'}</span></button>
                                </form>
                                #{/if}

                                #{if i.state.name() == models.DataSetState.QUEUED().name() || i.state.name() == models.DataSetState.PROCESSING().name()}
                                <div id="#indexCounter${i.spec}"></div>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/cancel" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button action cancel"><span class="label">&{'dataset.cancelindex'}</span>
                                    </button>
                                </form>
                                #{/if}

                                #{if i.state.name() == models.DataSetState.QUEUED().name()}
                                <script type="text/javascript">
                                    $('#description${i.spec}').smartupdater({
                                        url : "/organizations/${orgId}/dataset/${i.spec}/state",
                                        minTimeout: 2000
                                    }, function (data) {
                                        var d = $.parseJSON(data);
                                        if (d.state == '${models.DataSetState.PROCESSING().name()}' || d.state == '${models.DataSetState.ERROR().name()}') {
                                            // yadaaa
                                            document.location = "/organizations/${orgId}/dataset";
                                        }
                                    });
                                </script>
                                #{/if}

                                #{if i.state.name() == models.DataSetState.PROCESSING().name()}
                                <div id="indexCounter${i.spec}"></div>
                                <script type="text/javascript">
                                    $('#indexCounter${i.spec}').progressbar();
                                    $('#indexCounter${i.spec}').smartupdater({
                                        url : "/organizations/${orgId}/dataset/${i.spec}/indexingStatus",
                                        minTimeout: 2000
                                    }, function (data) {
                                        var d = $.parseJSON(data);
                                        if (d.status == 'DONE') {
                                            $('#indexCounter${i.spec}').smartupdaterStop();
                                            $('#indexCounter${i.spec}').progressbar("value", 100);
                                            document.location = "/organizations/${orgId}/dataset";
                                        }
                                        else {
                                            $('#indexCounter${i.spec}').progressbar("value", d.status);
                                        }
                                    });
                                </script>
                                #{/if}

                                #{if i.state.name() == models.DataSetState.DISABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/enable" method="POST">
                                    #{authenticityToken /}
                                    <button class="button action enable">&{'dataset.enable'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="button action complete invalidate"><span class="label">&{'dataset.invalidate'}</span></button>
                                </form>
                                #{/if}


                            #{/if}
                            </div>
                        </td>
                    </tr>
                    #{/list}
                    </tbody>
                </table>
            </div>


            #{/}
            #{else}
            <p>${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}</p>
            #{/}
        </div>




<script type="text/javascript" language="javascript">
$(document).ready(function()
    {
      $("#dataset-table").tablesorter();

      var theTable = $('#dataset-table')

      theTable.find("tbody > tr").find("td:eq(1)").mousedown(function(){
        $(this).prev().find(":checkbox").click()
      });

      $("#filter").keyup(function() {
        $.uiTableFilter( theTable, this.value );
      })

      $('#filter-form').submit(function(){
        theTable.find("tbody > tr:visible > td:eq(1)").mousedown();
        return false;
      }).focus(); //Give focus to input field

    }
);
</script>