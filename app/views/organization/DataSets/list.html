#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.browse.of', messages.get('thing.datasets')) + ': ' + orgId /}

#{set 'moreScripts'}
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.tablesorter.min.js")}"></script>
<script type="text/javascript" src="@{routes.Assets.at("/common/javascripts/jquery.uitablefilter.js")}"></script>
#{/set}

#{set bodyId: 'organization' /}

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", isOwner: isOwner, isCMSAdmin: isCMSAdmin, currentLanguage: currentLanguage /}

<div class="row">
    <div class="span12">
#{if browsedUserName}
    <div class="row">
    &{'thing.organization'}: <span>${browsedOrgName}</span><br/>
    &{'thing.count'}: ${count}
    </div>
#{/if}
#{if items.length() > 0}

    <form id="filter-form" class="form-inline well">
        <label>&{'dataset.find'}: </label>
        <input type='text' name='filter' id='filter' maxlength="30" size="30" class="textinput" placeholder="Begin typing a DataSet name"/>
    </form>


    <table id="dataset-table" class="table table-striped sortable">
        <caption>${messages.get('thing.datasets')}</caption>
        <thead>
        <tr>
            <th width="200">&{'thing.name'}</th>
            <th>&{'ui.label.nritems'}</th>
            <th>&{'ui.label.status'}</th>
            <th>&{'ui.label.options'}</th>
        </tr>
        </thead>
        <tfoot>
        <tr>
            <td colspan="4">
            #{ifnot items.length() > 0}
                {messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}
            #{/ifnot}
            </td>
        </tr>
        </tfoot>
        <tbody>

        #{list items, as: 'i'}
        <tr>
            <td><a href="/organizations/${orgId}/dataset/${i.spec}">${i.spec}</a></td>
            <td width="100"><a href="/search?query=delving_spec%3A${i.spec}">${i.total_records}</a></td>
            <td id="description${i.spec}" width="150">
            *{todo enable this again after classloader fix}*
                            *{#{if i.state.name() == models.DataSetState.ERROR().name()}}*
                                *{<span class="error">${i.state.description()}</span>}*
                            *{#{/if}}*
                            *{#{else}}*
                                ${i.state.description()}
                            *{#{/else}}*
            </td>
            <td width="550">
                #{if isOwner}
                    <div class="btn-toolbar nom">
                        <div class="btn-group">
                            <a class="btn btn-primary" href="/organizations/${orgId}/dataset/${i.spec}/update">
                                ${messages.get('ui.label.edit')}
                            </a>
                        </div>

                            #{if i.state.name() == models.DataSetState.UPLOADED().name() || i.state.name() == models.DataSetState.ERROR().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/index" method="POST" class="data-set">
                                    <button class="btn">&{'dataset.index'}</button>
                                    #{authenticityToken /}
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    <button class="btn">&{'dataset.invalidate'}</button>
                                    #{authenticityToken /}
                                </form>
                            #{/if}

                            #{if i.state.name() == models.DataSetState.ENABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/reindex" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn">&{'dataset.reindex'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/disable" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn">&{'dataset.disable'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn">&{'dataset.invalidate'}</button>
                                </form>
                            #{/if}

                            #{if i.state.name() == models.DataSetState.QUEUED().name() || i.state.name() == models.DataSetState.INDEXING().name()}

                                <form action="/organizations/${orgId}/dataset/${i.spec}/cancel" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn"><span >&{'dataset.cancelindex'}</span>
                                    </button>
                                </form>

                            #{/if}

                            #{if i.state.name() == models.DataSetState.DISABLED().name()}
                                <form action="/organizations/${orgId}/dataset/${i.spec}/enable" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn">&{'dataset.enable'}</button>
                                </form>
                                <form action="/organizations/${orgId}/dataset/${i.spec}/invalidate" method="POST" class="data-set">
                                    #{authenticityToken /}
                                    <button class="btn"><span>&{'dataset.invalidate'}</span></button>
                                </form>
                            #{/if}

                    <div class="btn-group">
                        <a class="btn btn-warning #{if i.lockedBy.isEmpty()} disabled#{/if}" id="unlock${i.spec}">
                        ${messages.get('ui.label.unlock')}
                        </a>
                    </div>

                    <div class="btn-group">
                        <a class="btn btn-danger #{if i.state.name() == models.DataSetState.ENABLED().name()} disabled#{/if}" id="remove${i.spec}">
                        ${messages.get('ui.label.delete')}
                        </a>
                    </div>



                        <div id="removeConfirmation" title="&{'thing.confirmation'}" style="display: none;">
                            <p>
                            <span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>&{'dataset.confirmDeletion'}
                            </p>
                        </div>
                        <script type="text/javascript">
                            $(document).ready(function () {
                                remove('#remove${i.spec}', '#removeConfirmation', '/organizations/${orgId}/dataset/${i.spec}/remove', '/organizations/${orgId}/dataset');
                                $('#unlock${i.spec}').click(function () {
                                    $.ajax({
                                        url:'/organizations/${orgId}/dataset/${i.spec}/forceUnlock',
                                        type:'POST',
                                        complete:function () {
                                            document.location = "/organizations/${orgId}/dataset";
                                        }
                                    });
                                });
                            });
                        </script>

                        #{if i.state.name() == models.DataSetState.QUEUED().name()}
                            <script type="text/javascript">
                                $('#description${i.spec}').smartupdater({
                                    url:"/organizations/${orgId}/dataset/${i.spec}/state",
                                    minTimeout:2000
                                }, function (data) {
                                    var d = $.parseJSON(data);
                                    if (d.state == '${models.DataSetState.INDEXING().name()}' || d.state == '${models.DataSetState.ERROR().name()}') {
                                        // yadaaa
                                        document.location = "/organizations/${orgId}/dataset";
                                    }
                                });
                            </script>
                        #{/if}

                        #{if i.state.name() == models.DataSetState.INDEXING().name()}

                            *{<div class="progress progress-striped active">}*
                                <div class="progress"  id="indexCounter${i.spec}"></div>
                            *{</div>}*
                            <script type="text/javascript">
                                $('#indexCounter${i.spec}').progressbar();
                                $('#indexCounter${i.spec}').smartupdater({
                                    url:"/organizations/${orgId}/dataset/${i.spec}/indexingStatus",
                                    minTimeout:2000
                                }, function (data) {
                                    var d = $.parseJSON(data);
                                    if (d.status == 'DONE') {
                                        $('#indexCounter${i.spec}').smartupdaterStop();
                                        $('#indexCounter${i.spec}').progressbar("value", 100);
                                        document.location = "/organizations/${orgId}/dataset";
                                    }
                                    else {
                                        $('#indexCounter${i.spec}').progressbar("value", d.status);
                                    }
                                });
                            </script>
                        #{/if}

                        *{** INDEXING PROGRESS BAR **}*
                        *{<div id="#indexCounter${i.spec}"></div>}*


                #{/if}

            </div>
            </td>
        </tr>
        #{/list}
        </tbody>
    </table>



#{/}
#{else}
    <p>${messages.get('thing.notavailable.plural', messages.get('thing.datasets'))}</p>
#{/}
</div>
</div>

<script type="text/javascript" language="javascript">
    $(document).ready(function () {
                $("#dataset-table").tablesorter();

                var theTable = $('#dataset-table')

                theTable.find("tbody > tr").find("td:eq(1)").mousedown(function () {
                    $(this).prev().find(":checkbox").click()
                });

                $("#filter").keyup(function () {
                    $.uiTableFilter(theTable, this.value);
                })

                $('#filter-form').submit(
                        function () {
                            theTable.find("tbody > tr:visible > td:eq(1)").mousedown();
                            return false;
                        }).focus(); //Give focus to input field

            }
    );
</script>