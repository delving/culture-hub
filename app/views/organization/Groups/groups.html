#{set 'visibility'}hidden#{/set}
#{extends themeInfo.get('themeLayout') /}

#{set title: messages.get('thing.groups') /}

#{set bodyId: 'organization' /}

#{breadcrumbs configuration: themeInfo.getConfiguration() /}

#{organizationNavBar orgId: orgId, active:"groups", navigation: navigation /}

<h3>&{'org.group.create'}</h3>

<div class="row">
    <form action="" id="groupForm" class="form-delving">
        <div class="span6">
            #{form.textField name:"name", form: groupForm, label:messages.get('thing.name'), dataBind:"value: name, enable: canChangeGrantType", required: true /}
            <div class="control-group" data-bind="visible: canChangeGrantType">
                <label class="control-label" for="grantType">&{'thing.grantType'}<span class="label">&{'ui.label.required'}</span></label>
                <div class="controls">
                    <select id="grantType" name="grantType" data-bind="value: grantType" class="span4">
                    #{list grantTypes, as: 'gt'}
                        <option value="${gt.key}">&{gt.value}</option>
                    #{/list}
                    </select>
                    <span class="error">${views.Helpers.showError('grantType', null)}</span>
                </div>
            </div>
        </div>
        <div class="span6">
            <div class="control-group">
                <label class="control-label" for="users">&{'thing.users'}</label>
                <div class="controls">
                #{if id.isDefined()}
                    #{addRemoveTokenField id:"users", name: "users", searchUrl: "/organizations/"+orgId+"/users/search", prePopulate: users, addUrl: "/organizations/"+orgId+"/groups/"+id.get()+"/addUser", removeUrl: "/organizations/"+orgId+"/groups/"+id.get()+"/removeUser" /}
                #{/if}
                #{else}
                    #{boundAddRemoveTokenField id:"users", name:"users", searchUrl: "/organizations/"+orgId+"/users/search", dataBind:"tokens: users" /}
                #{/else}
                    <p>&{'org.admin.index.addMembers'}</p>
                </div>
            </div>

            *{ TODO generify to resource of any kind, not only DataSet }*
            <div class="control-group" data-bind="visible: canChangeGrantType() && (grantType() == 'canView' || grantType() == 'canUpdate')">
                <label class="control-label" for="datasetsInput">&{'thing.datasets'}</label>
                <div class="controls">
                #{if id.isDefined()}
                    #{addRemoveTokenField id:"datasetsInput", name: "datasetsInput", searchUrl: "/organizations/"+orgId+"/datasets/searchBySpec", prePopulate: dataSets, addUrl: "/organizations/"+orgId+"/groups/"+id.get()+"/addDataset", removeUrl: "/organizations/"+orgId+"/groups/"+id.get()+"/removeDataset" /}
                #{/if}
                #{else}
                    #{boundAddRemoveTokenField id:"datasetsInput", name:"datasetsInput", searchUrl: "/organizations/"+orgId+"/datasets/searchBySpec", dataBind:"tokens: dataSets" /}
                #{/else}
                </div>
            </div>
            <div class="well">
            #{btnButton label: messages.get('org.group.save'), extraClass:"btn-primary btn-promiment", id:"saveButton", type:"submit" /}
            <div class="wait"></div>
            </div>
        </div>
    </form>
</div>


<script type="text/javascript">
    $(document).ready(function () {
        var groupModel = {};
        load(${data.raw()}, groupModel, null, function () {
            $("body").css('visibility', 'visible');
        });

        $('#saveButton').click(function (event) {
            event.preventDefault();
            handleSubmit('/organizations/${orgId}/groups/update/${views.Helpers.getOrElse(id, "")}', groupModel, '#groupForm', '/organizations/${orgId}/groups/update/', null, null);
        });
    });
</script>