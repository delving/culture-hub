#{set 'visibility'}hidden#{/}
#{extends themeInfo.get('themeLayout') /}
#{set title: messages.get('organization.dataset.create') /}
#{set bodyId: 'organization' /}

<style>
    .ui-autocomplete {
      position: absolute;
      top: 100%;
      left: 0;
      z-index: 1000;
      float: left;
      display: none;
      min-width: 160px;
      _width: 160px;
      padding: 4px 0;
      margin: 2px 0 0 0;
      list-style: none;
      background-color: #ffffff;
      border-color: #ccc;
      border-color: rgba(0, 0, 0, 0.2);
      border-style: solid;
      border-width: 1px;
      -webkit-border-radius: 5px;
      -moz-border-radius: 5px;
      border-radius: 5px;
      -webkit-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      -moz-box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
      -webkit-background-clip: padding-box;
      -moz-background-clip: padding;
      background-clip: padding-box;
      *border-right-width: 2px;
      *border-bottom-width: 2px;

      .ui-menu-item > a.ui-corner-all {
        display: block;
        padding: 3px 15px;
        clear: both;
        font-weight: normal;
        line-height: 18px;
        color: #555555;
        white-space: nowrap;

        &.ui-state-hover, &.ui-state-active {
          color: #ffffff;
          text-decoration: none;
          background-color: #0088cc;
          border-radius: 0px;
          -webkit-border-radius: 0px;
          -moz-border-radius: 0px;
          background-image: none;
        }
      }
    }
</style>

#{breadcrumbs /}

#{organizationNavBar orgId: orgId, active:"datasets", isOwner: isOwner, currentLanguage: currentLanguage /}

    <div class="row">
        <div class="span12">
            <div class="page-header">
            <h2>${spec.isEmpty() ? messages.get('organization.dataset.create') : messages.get('organization.dataset.update') }</h2>
            </div>
            <form method="post" action="" id="collectionForm" class="form-delving">
                <div class="row">
                    <div class="span6">

                        #{textField name:"spec", form: dataSetForm, label: messages.get('organization.dataset.label.identifier'), dataBind:"value: spec", help: messages.get('organization.dataset.help.identifier') /}

                        %{for(i in 0..factDefinitions.size() - 1) {
                            def factDef = factDefinitions.apply(i);
                        }%

                        #{if factDef.hasOptions()}
                            #{populatedSelectField name: "facts." + factDef.name, form: dataSetForm, label: factDef.prompt, options: factDef.opts, dataBind: "value: facts." + factDef.name, help: factDef.tooltip /}
                        #{/if}
                        #{else}
                            #{textField name: "facts." + factDef.name, form: dataSetForm, label: factDef.prompt, dataBind: "value: facts." + factDef.name, help: factDef.tooltip, isDisabled: factDef.automatic /}
                        #{/else}

                        %{ }}%

                        <div class="control-group">
                            <label class="control-label">&{'ui.label.visibility'}</label>
                            <div class="controls">
                                <label class="radio">
                                    <input type="radio" name="public" value="${models.Visibility.PRIVATE().value}" data-bind="checked: visibility"/>
                                &{'ui.label.visibility.notpublic'}
                                </label>
                                <label class="radio">
                                    <input type="radio" name="public" value="${models.Visibility.PUBLIC().value}" data-bind="checked: visibility"/>
                                &{'ui.label.visibility.public'}
                                </label>
                            </div>
                        </div>

                    </div>
                    <div class="span6">
                        <div class="control-group">
                            <label class="control-label">Target Record Definitions</label>
                            <div class="controls">
                                <table class="table">
                                <thead><th width="150">Record Definition</th><th>OAI-PMH Access</th></thead>
                                <tbody>
                                #{list recordDefinitions, as: 'recordDef'}
                            <tr>
                                <td align="left">#{checkboxField name: recordDef + "_field", label: recordDef, value: recordDef, dataBind: "checked: recordDefinitions" /}</td>
                                <td align="left">
                                <span data-bind="visible: recordDefinitions().indexOf('${recordDef}') > -1">
                                    <select id="oaiAccess-${recordDef}">
                                        <option value="none">No access</option>
                                        <option value="public">Public access</option>
                                        <option value="protected">Protected access</option>
                                    </select>
                                    <span id="protected-${recordDef}" style="display: none;">
                                        <label for="accessKey-${recordDef}">Access key</label>
                                        <input type="text" id="accessKey-${recordDef}">
                                    </span>
                                </span>
                                </td>
                            </tr>
                            #{/list}
                                </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="control-group">
                            <label class="control-label">Indexing Mapping Record Definition</label>
                            <div class="controls">
                                <select id="mapping-prefix" name="mapping-prefix" data-bind="options: recordDefinitions, optionsCaption: 'Select a mapping for indexing', value: indexingMappingPrefix"></select>
                                <span class="error" data-bind="text: errors().indexingMappingPrefix"></span>
                            </div>
                        </div>

                        <hr/>
                        <div class="well">
                            <div class="row">
                                #{btnHref id:"saveButton", name:"saveButton", label:messages.get('organization.dataset.save'), extraClass:"btn-success btn-large span4", iconClass:"icon-ok-circle icon-white"/}
                                <button type="reset" class="btn pull-right">Reset</button>
                            </div>
                        </div>
                    </div>
                </div>

            </form>
        </div>
    </div>

<script type="text/javascript">
    $(document).ready(function() {
        var dataSetModel = {};

        $('#saveButton').click(function(event) {
            event.preventDefault();
            handleSubmit('/organizations/${orgId}/dataset/submit', dataSetModel, '#collectionForm', null, function() {
                window.location.href = '/organizations/${orgId}/dataset/' + dataSetModel.spec.call();
            });
        });

        load(${data.raw()}, dataSetModel, null, function() {

            // set initial state of visible oai-pmh access control settings
            $.each(dataSetModel.oaiPmhAccess(), function(index, access) {
                $('#oaiAccess-' + access.format()).val(access.accessType());
                if(access.accessType() == 'protected') {
                    $('#accessKey-' + access.format()).val(access.accessKey());
                    $('#protected-' + access.format()).css('display', 'block');
                }
            });

            // listen to oaiPmh accessType changes
            $.each(dataSetModel.allRecordDefinitions(), function(index, prefix) {
                $('#oaiAccess-' + prefix).change(function() {
                    var access = dataSetModel.oaiPmhAccess.remove(function(it) { return it.format() == prefix; });
                    var selectedValue = $('#oaiAccess-' + prefix).val();

                    if(selectedValue == "protected") {
                        $('#protected-' + prefix).css('visibility', 'visible');
                    } else {
                        $('#protected-' + prefix).css('visibility', 'hidden');
                    }

                    if(access.length > 0) {
                        access[0].accessType(selectedValue);
                    } else {
                        access[0] = {
                            format: ko.observable(prefix),
                            accessType: ko.observable(selectedValue)
                        }
                    }
                    dataSetModel.oaiPmhAccess.push(access[0]);
                });
            });

            // do the same thing for the accessKeys
            $.each(dataSetModel.allRecordDefinitions(), function(index, prefix) {
                $('#accessKey-' + prefix).change(function() {
                    var access = dataSetModel.oaiPmhAccess.remove(function(it) { return it.format() == prefix; });
                    var accessKeyValue = $('#accessKey-' + prefix).val();

                    if(access.length > 0) {
                        access[0].accessKey = ko.observable(accessKeyValue);
                    } else {
                        access[0] = {
                            format: ko.observable(prefix),
                            accessType: ko.observable("protected"),
                            accessKey: ko.observable(accessKeyValue)
                        }
                    }
                    dataSetModel.oaiPmhAccess.push(access[0]);
                });
            });

            $("[id='facts.provider']").autocomplete({
                source: '/organizations/${orgId}/directory/organizationLookup',
                select: function(event, ui) {
                   dataSetModel.facts.provider(ui.item.value);
                }
            });

            $("[id='facts.dataProvider']").autocomplete({
                source: '/organizations/${orgId}/directory/organizationLookup',
                select: function(event, ui) {
                   dataSetModel.facts.dataProvider(ui.item.value);
                }
            });

            $("body").css('visibility', 'visible');
        });
    });
</script>