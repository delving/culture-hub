#{extends 'header.html' /}
#{set title: spec.isEmpty() ? 'Create new dataset for user ' + fullName : 'Update dataset for user ' + fullName /}
#{breadcrumbs /}

<h1 class="grid_16">${spec.isEmpty() ? "Create a new dataset" : "Update a dataset" }</h1>

<form method="post" action="" id="collectionForm" class="grid_16">

    <div class="grid_8 alpha">

    <h2>Data Set Information</h2>

    #{textField name:"spec", label:"Identifier", dataBind:"value: spec", help:"The unique identifier of this DataSet" /}

    %{for(i in 0..factDefinitions.size() - 1) {
      def factDef = factDefinitions.get(i);
    }%
      #{if factDef.hasOptions()}
        #{populatedSelectField name: factDef.name + "_field", label: factDef.prompt, options: factDef.opts, dataBind: "value: facts." + factDef.name, help: factDef.tooltip /}
      #{/if}
      #{else}
        #{textField name:factDef.name + "_field", label: factDef.prompt, dataBind: "value: facts." + factDef.name, help: factDef.tooltip, isDisabled: factDef.automatic /}
      #{/else}
      #{if i == 4}
      </div>
      <div class="grid_8 omega">
      #{/if}
    %{ } }%
    <h2>Record Definitions</h2>
    #{list recordDefinitions, as: 'recordDef'}
      #{checkboxField name: recordDef + "_field", label: recordDef, value: recordDef, dataBind: "checked: recordDefinitions" /}
    #{/list}
    </div>

    <div class="clear"></div>
    <div class="actions">
        <input id="saveButton" type="submit" value="Save DataSet" />
    </div>

  </div>
</form>

<script type="text/javascript">
  $(document).ready(function() {
    var dataSetModel = {};

    $('#saveButton').click(function(event) {
      event.preventDefault();
      handleSubmit('/${userName}/dataset/submit', dataSetModel, '#collectionForm', null, function() {  window.location.href = '/${userName}/dataset/' + dataSetModel.spec.call(); });
    });

    load('/${userName}/dataset/load/${spec.isEmpty() ? "" : spec.get()}', dataSetModel);
  });
</script>