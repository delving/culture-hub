#{extends viewUtils.themeProperty('themeLayout') /}

#{set title:'Search results' /}

#{set bodyId: 'results' /}

#{set 'moreCss'}
<link rel="stylesheet" type="text/css" media="screen" href="@{'/public/common/stylesheets/facets/facets.css'}"/>
#{/set}

#{set 'moreScripts'}
<script src="@{'/public/common/javascripts/results.js'}" type='text/javascript'></script>
#{/set}

#{breadcrumbs /}

#{if briefDocs }

    <div class="g-12of12 grid_12">
        <div class="item-count mtm mbm">
            &{'search.trail', pagination.getStart(), pagination.getLastViewableRecord(), pagination.getNumFound() }
            <ul class="breadcrumb">
                #{list pagination.getBreadcrumbs(), as: 'crumb'}
                #{ifnot crumb_isLast}
                <li><a href="@{Search.index()}?${crumb.href()}"><span>${crumb.value().shorten(50)}</span></a></li>
                #{/ifnot}
                #{else}
                <li><span>${crumb.value()}</span></li>
                #{/else}
                #{/list}
            </ul>
        </div>
    </div>

    <div class="row">
        <div class="g-8of12 grid_8">
            #{if pagination.getNumFound() > views.context.package.PAGE_SIZE()}
            <div class="pager mbl">
                #{resultPagination pageLinks: pagination, pQuery: pagination.getPresentationQuery().getQueryForPresentation() /}
            </div>
            #{/if}
            <div class="results">
                #{resultGrid results: briefDocs /}
            </div>
            #{if pagination.getNumFound() > views.context.package.PAGE_SIZE()}
            <div class="pager">
                #{resultPagination pageLinks: pagination, pQuery: pagination.getPresentationQuery().getQueryForPresentation() /}
            </div>
            #{/if}
        </div>
        <div class="g-4of12 grid_4">
            <div class="legend">

            </div>
            <div class="facets">
                <div class="widget">
                    <div class="hd"><h3>&{'search.refineYourSearchBy'}:</h3></div>
                    <div class="bd">
                    #{list items: themeFacets, as: 'tf'}
                      #{facet facetMap: facets, type: tf.facetName()+'_facet', typeKey: viewUtils.getKey(tf.facetInternationalisationCode()), qString: pagination.getPresentationQuery().getUserSubmittedQuery(), columns: tf.nrDisplayColumns /}
                    #{/list}
                    </div>
                </div>
            </div>

            #{if userName}
            <div id="dropbox" class="widget object">
                <div class="hd"><h3>&{'search.addItemsToCollection'}</h3></div>
                <div class="bd">
                    <div id="dropbox-info"><p>&{'search.dragItems'}</p></div>
                    <form action="" method="post" class="dropbox">
                        <ul></ul>
                        <div id="dropbox-actions">
                            #{if collections}
                                <select name="collection" id="dropbox-collection">
                                 <option selected='selected'>&{'user.story.label.selectCollection'}</option>
                                 #{list collections, as: 'col'}
                                    <option value="${col.id}">${col.title}</option>
                                 #{/list}
                                </select>
                                <hr/>
                                <button id="addToCollectionButton" type="submit" class="button action submit">&{'search.addToCollection'}</button>
                            #{/if}
                            #{else}
                                <hr>
                                You have no collections. <a href="/${userName}/collection/add">Create a collection</a> so that you can save items into them.
                            #{/else}
                        </div>
                    </form>

                </div>
            </div>
                #{/if}
                *{ <!-- commented out for now until functionality is there -->
                <div class="dropdown">
                    #{btnHref label: viewUtils.getKey('search.sortby'), toggle:true/}
                    <div class="dropdown-slider">
                        <a href="#" class="ddm"><span class="label">&{'thing.object'}</span></a>
                        <a href="#" class="ddm"><span class="label">&{'thing.collection'}</span></a>
                    </div>
                </div>
                }*
            </div>
    </div>

#{/if}

#{else}
    <div class="g-12of12 grid_12 centered pam">
        &{'ui.message.nothingFound'}
    </div>
#{/else}

<!-- overlayed element -->
<div id="overlay" class="result-overlay">
    <!-- the external content is loaded inside this tag -->
    <div class="contentWrap"></div>
</div>

<script type="text/javascript">
  $(document).ready(function() {

  $('#dropbox').dropbox();

  $('#addToCollectionButton').click(function(event) {
        event.preventDefault();
        $('#dropbox input[name="itemId"]').each(function() {
          var uri = $(this).val();
          $.ajax({
            type: 'POST',
            url: uri + '/link/partOf/collection/' + $('#dropbox-collection').val(),
            success: function() {
              $('#dropbox').trigger({
                type: 'removeItem',
                itemId: uri
              });
            },
            error: function() {
                $("select#dropbox-collection").css("background","#cc3300").effect("bounce", { times:4 }, 200);
                setTimeout('$("select#dropbox-collection").delay(800).css("background","#ffffff")', 1500);
            }
          });
        });
      });

  });
</script>
